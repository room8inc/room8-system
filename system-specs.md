# Room8 システム仕様書

## 会議室・設備管理

### 会議室
- **数**: 1室のみ
- **管理**: システムで自動管理

### ロッカー
- **管理方法**: 管理画面から手動で調整可能
- **機能**: 管理者がロッカーの数や空き状況を手動で管理できる

---

## チェックイン/チェックアウトシステム

### チェックイン方法
- **方法**: QRコード読み取り（会場に設置されているQRコード）
- **実装**: 
  1. アプリで会場のQRコードを読み取る
  2. **ログイン状態（セッション）から個人情報を自動取得**
  3. 会場ID（QRコード）+ ユーザーID（ログインセッション）でチェックイン実行
- **個人識別**: ログイン状態（セッション）に保存されているユーザーIDで個人を識別
- **QRコードを二回読む必要はない**（会場のQRコード一度だけ）

### チェックアウト方法
- **方法**: QRコード読み取り（会場に設置されているQRコード）
- **実装**: 
  1. アプリで会場のQRコードを読み取る
  2. **ログイン状態（セッション）から個人情報を自動取得**
  3. 会場ID（QRコード）+ ユーザーID（ログインセッション）でチェックアウト実行
- **個人識別**: ログイン状態（セッション）に保存されているユーザーIDで個人を識別

### QRコードの用途と内容

#### 会場のQRコード（入退室用）
- **内容**: 会場ID（例：「room8-venue-001」）
- **用途**: チェックイン/チェックアウト時に会場を識別
- **個人識別**: QRコード自体には個人情報は含まれない
- **個人識別方法**: ログイン状態（セッション）に保存されているユーザーIDで個人を識別
- **処理フロー**: 
  ```
  会場QRコード読み取り
  → 会場ID取得
  → ログインセッションからユーザーID取得（自動）
  → チェックイン/チェックアウト実行（会場ID + ユーザーID）
  ```

#### 個人用QRコード（ログイン用）
- **内容**: ユーザーID + トークン（認証用）
- **用途**: ログイン認証（初回のみ、またはログイン状態が切れた時）
- **個人識別**: QRコードにユーザーIDが含まれるため個人を識別可能

#### 会議室QRコード
- **内容**: 会議室ID（例：「room8-meetingroom-001」）
- **用途**: 会議室利用開始/終了時に会議室を識別
- **個人識別**: ログイン状態（セッション）からユーザーIDを取得

### ログイン認証

**基本方針：通常ログイン（メイン） + LINE連携（オプション）**

#### メイン：メール+パスワードログイン
- **ログイン方法**: 
  - メールアドレス + パスワードでログイン
  - ブックマークに保存しておけば簡単にアクセス
  - ID・パスワードを手入力でOK
  - ログイン状態保持：30日間自動ログイン維持
  - **次回以降**: アプリを開けば自動的にログイン済み（セッション維持）
- **パスワード保存機能**: ブラウザの機能を活用（ユーザーが選択可能）

#### オプション：LINE連携（Phase 2で追加）
- **LINEログイン**: LINEアカウントでログイン（なくても使える）
- **LINE公式アカウント誘導**: LINE公式アカウントから「チェックイン」ボタンをタップでサイトへ誘導
- **ブックマーク不要**: LINEユーザー向けのメリット

### ユーザーフロー（確定版）

#### ログイン（事前に実施）

**方針：選択肢B（事前ログイン + 会場ではQRのみ）**

1. **初回ログイン（自宅やオフィスで事前に）**: 
   - メールアドレス + パスワードでログイン
   - 「ログイン状態を保持」にチェック（30日間維持）
   - パスワード保存機能（ブラウザの機能）も活用可能
   - ユーザーIDをセッションに保存

2. **次回以降**: 
   - アプリを開けば自動的にログイン済み（30日間維持）
   - セッションからユーザーIDを自動取得
   - パスワード保存機能があれば、簡単に再ログイン可能

#### チェックイン/チェックアウト（会場で）

1. **会場で**: 
   - アプリを開く（既にログイン済み状態）
   - 会場のQRコードを一度読むだけ
   - **処理内容**:
     - 会場QRコードから会場IDを取得
     - ログインセッションからユーザーIDを自動取得
     - チェックイン/チェックアウト実行（会場ID + ユーザーID）
   - **ログイン画面は表示されない**（既にログイン済みのため）
   - **QRコードを二回読む必要はない**

**フォールバック：**
- ログイン状態が切れた場合のみ、会場でログイン画面を表示
- パスワード保存機能があれば、簡単に再ログイン可能

### 個人識別の仕組み

#### 会場のQRコード読み取り時（詳細）

**重要なポイント: ユーザーIDはサーバー側のセッションから取得します（端末からは送信されません）**

```
[クライアント側（端末）]
  ↓
会場QRコード読み取り
  ↓
会場ID取得（例：「room8-venue-001」）
  ↓
チェックインAPIを呼び出す
  - 会場ID: "room8-venue-001"（リクエストボディ）
  - セッショントークン: "session-token-xyz"（Cookieから自動送信）
  ↓
[サーバー側]
  ↓
セッショントークンを検証
  ↓
サーバー側のセッションストレージからユーザーIDを取得
  - セッショントークン "session-token-xyz" → ユーザーID "user-12345"
  ↓
チェックイン/チェックアウト実行
  - 会場ID: room8-venue-001（リクエストから）
  - ユーザーID: user-12345（サーバー側のセッションから）
  - 時刻: 2025-11-01 10:00:00
```

#### セキュリティ
- **ログインセッション**: サーバー側でユーザーIDを管理（データベースやRedis）
- **セッショントークン**: 端末にはトークンのみ保存（ユーザーIDは保存しない）
- **会場QRコード**: 個人情報は含まれない（会場IDのみ）
- **個人識別**: サーバー側のセッション（トークン→ユーザーID）と会場QRコードの組み合わせで個人を識別

詳細は [セッション管理・個人識別の仕組み](./session-management.md) を参照してください。

---

## 会員登録時の情報

### 個人会員の必須項目
- **基本情報**
  - 氏名（姓・名）
  - フリガナ（姓・名）
  - メールアドレス
  - 電話番号
  - 生年月日
  
- **住所情報**
  - 郵便番号
  - 都道府県
  - 市区町村
  - 番地・建物名
  
- **認証情報**
  - パスワード
  - パスワード確認
  
- **身分証明書**
  - 身分証明書の写メ（必須）
  - アップロード機能

- **決済情報**（定期会員の場合）
  - クレジットカード情報
  - または銀行振込の選択

### 法人会員の必須項目
- **基本情報**
  - 法人名
  - 法人名フリガナ
  - 代表者氏名
  - 代表者フリガナ
  - 担当者氏名
  - 担当者フリガナ
  
- **連絡先情報**
  - メールアドレス
  - 電話番号
  - FAX番号（任意）
  
- **住所情報**
  - 郵便番号
  - 都道府県
  - 市区町村
  - 番地・建物名
  
- **認証情報**
  - パスワード
  - パスワード確認
  
- **法人書類**
  - 登記簿謄本の写メ（必須）
  - アップロード機能

- **決済情報**
  - クレジットカード情報
  - または銀行振込の選択

### ドロップイン会員の必須項目
- **基本情報**
  - 氏名（姓・名）
  - フリガナ（姓・名）
  - メールアドレス
  - 電話番号
  
- **認証情報**
  - パスワード
  - パスワード確認
  
- **決済情報**
  - クレジットカード情報（必須）

### 任意項目（全会員共通）
- プロフィール写真
- 自己紹介
- 利用目的
- 紹介者情報

---

## 時間外利用の詳細仕様

### 猶予時間システム
- **猶予時間**: 10分まで無料
- **目的**: サービス提供（片付けなどで少しオーバーしても許容）
- **例**: デイタイムプラン（17時まで）の場合
  - 17:00〜17:10：無料（猶予時間）
  - 17:10〜17:15：無料（猶予時間内）
  - 17:15以降：課金開始

### 課金ルール
- **課金開始**: 15分超過から課金
- **料金体系**: ドロップインと同じ
  - 30分：200円
  - 1時間：400円
  - 最大料金：2,000円（税込み）
- **計算単位**: 30分単位（15分超えたら30分課金）

### 計算例
- **デイタイムプラン（17時まで）で17:30まで利用した場合**
  - 猶予時間（10分）：17:00〜17:10 → 無料
  - 課金対象時間：17:10〜17:30（20分）
  - 15分超過なので30分課金 → 200円

### 課金タイミング
- 定額会員：会議室利用と合算して月末（翌月1日）にまとめて請求
- クレジットカード自動引き落とし

---

## 会議室利用・決済

### 会議室の基本情報
- **数**: 1室のみ
- **予約管理**: システムで自動管理

### 決済タイミング

#### ドロップイン会員
- **タイミング**: 予約確定時に即座に決済
- **方法**: クレジットカード決済

#### 定額会員
- **タイミング**: 月末（翌月1日）にまとめて請求
- **対象**: 
  - 会議室利用料金
  - 時間外利用追加料金
  - その他の追加料金
- **方法**: クレジットカード自動引き落とし
- **決済失敗時の対応**：
  - ダッシュボードの目立つ位置に警告を表示
  - 利用は可能だが、確認・決済を促す
  - 直ちに使えなくする必要はない（ユーザーフレンドリーな対応）

#### ドロップイン決済方式（デビットカード対応）
- **問題**: デビットカードの場合、チェックアウト時に決済できない可能性がある
  - デビットカードは残高不足や取引制限により、後から決済できない場合がある
- **解決策**: チェックイン時に最大料金（2,000円）を事前決済（オーソリ）
  - **チェックイン時**：
    - StripeのAuthorization（承認保留）を使用して最大料金（2,000円）を確保
    - または即座に2,000円をチャージ（Capture）
  - **チェックアウト時**：
    - 実際の利用時間に応じた料金を計算（例：2時間 = 800円）
    - 差額を返金（例：2,000円 - 800円 = 1,200円を返金）
- **メリット**: 
  - デビットカードでも確実に決済できる
  - 利用上限を保証できる
  - 残高不足を事前に防げる
- **技術的実装**: 
  - Stripeの「Payment Intents」でAuthorization and Captureを使用
  - または即座にCaptureしてRefund機能で差額を返金
  - Stripeの返金は通常数日で反映される（カード会社による）

### 会議室料金（再掲）
- **定額会員（一般）**: 1,100円/時間
- **定額会員（シェアオフィスプラン）**: 月4時間まで無料、超過分1,100円/時間
- **定額会員以外（ドロップイン会員）**: 2,200円/時間

---

## UI設計・導線（利用者目線）

### ダッシュボードの構成方針

#### 優先順位（上から順）

1. **ヘッダー**
   - 氏名を大きく表示（emailではなく）
   - ログアウトボタン

2. **決済失敗警告（定額会員向け・最優先表示）**
   - **定額会員で決済が失敗している場合**：
     - ダッシュボードの目立つ位置（メインアクションエリアの上部）に警告を表示
     - 「⚠️ 決済に失敗しています。支払い方法を確認してください」のようなメッセージ
     - 利用は可能だが、確認・決済を促す
     - 「支払い方法を確認」ボタンで決済設定画面へ遷移
     - **重要**: 直ちに使えなくする必要はない（ユーザーフレンドリーな対応）

3. **メインアクションエリア（最優先）**
   - **チェックイン/チェックアウトボタン**を大きく、目立つ位置に配置
   - **チェックイン中の場合**：
     - 経過時間をリアルタイム表示
     - **ドロップイン会員**：現在の料金をリアルタイム表示（1時間400円、最大2,000円）
     - **定期会員**：
       - プランの利用可能時間/リミットを表示（例：「利用可能: 17:00まで」）
       - 現在時刻と残り時間を表示（例：「現在: 15:30（残り1.5時間）」）
       - **時間外利用中**の場合：
         - 「⚠️ 時間外利用中」と表示
         - 追加料金をリアルタイム表示（10分猶予、15分超過から課金）

4. **その他のアクション**
   - 会議室予約ボタン

4. **その他の情報**
   - 今日の利用状況、利用履歴など

### フッターナビゲーション（常時表示）

**位置**: 全ページの下部に固定表示

**構成**:
- **ホーム** 🏠 → `/dashboard`
- **スキャン** 📷 → チェックイン/チェックアウトモーダル（現在の状態に応じて自動判定）
- **会議室** 🏢 → `/meeting-rooms`（Phase 3で実装）
- **会員証** 🎫 → `/member-card`

**目的**: どのページからでも主要機能にアクセス可能

### 会員証画面の構成

#### 上部：会員証カード
- **表示内容**:
  - 氏名
  - プラン名（定期会員の場合）
  - 会員種別（定期/ドロップイン）
  - 会員番号（任意、ユーザーIDから生成）

#### 下部：メニューリスト
- **会員情報** → `/profile`（プロフィール編集）
- **パスワード変更** → （Phase 2で実装）
- **決済履歴・領収書** → （Phase 2で実装）
- **定額契約** → プラン情報、契約期間、変更履歴（Phase 4で実装）
- **支払方法** → クレジットカード変更（Phase 2で実装）
- **ログアウト**

### チェックイン/チェックアウトのUX

**改善方針**: 手間を最小限に
- ダッシュボードの「チェックイン」ボタンをクリック → 即座にカメラ起動（モーダル表示）
- ダッシュボードの「チェックアウト」ボタンをクリック → 即座にカメラ起動（モーダル表示）
- ページ遷移なし、ワンクリックでカメラ起動

---

## システム要件

### コスト要件
- **目標**: なるべく低コストで実現
- **開発コスト削減**: MCPサーバー等を活用
- **運用コスト削減**: クラウドサービスの選定に注意

### 技術要件
- **開発効率化**: MCPサーバー等を使用して開発コストを削減
- **スケーラビリティ**: 将来的な拡張を考慮
- **保守性**: メンテナンスしやすい構造

### 推奨技術スタック（提案）
- **フロントエンド**: React / Next.js（低コストで効率的）
- **バックエンド**: Node.js / Python（MCP対応しやすい）
- **データベース**: PostgreSQL（無料枠あり）/ SQLite（開発初期）
- **決済**: Stripe / 他の低コスト決済サービス
- **認証**: Firebase Auth / 自前実装
- **ホスティング**: Vercel / Railway / AWS（無料枠活用）

---

## 次ステップ
1. ✅ 時間外利用の追加課金詳細（完了）
2. ✅ 会議室決済タイミング（完了）
3. ✅ 会議室・設備情報（完了）
4. ✅ チェックイン/チェックアウト方法（完了）
5. ✅ 会員登録時の情報（完了）
6. ✅ システム要件（完了）
7. ⏳ データベース設計
8. ⏳ API設計
9. ⏳ 技術スタック最終決定
10. ⏳ 実装開始

