# Room8 - コワーキングスペース管理システム

Room8は、コワーキングスペース運営のための包括的なWebアプリケーションです。会員管理、スペース利用管理、会議室予約、決済処理などの機能を統合し、データドリブン経営を実現することを目指しています。

## 📋 プロジェクト概要

### 最終ゴール
**データドリブン経営の実現**
- 会員動向を全てデータ化して分析できる状態にする
- 各種データを可視化・分析して意思決定に活用

### 主な機能

#### 1. 会員管理
- **定期会員（Room8会員）**：約9プラン（平日のみ、夜のみ、土日のみ、シェアオフィス、コワーキングスペースなど）
- **ドロップイン会員**：1時間利用可能な会員
- 会員登録・退会処理
- プラン変更処理
- オプション管理（ロッカーなど）

#### 2. チェックイン/チェックアウトシステム
- 定期会員向けの入退室管理
- ドロップイン会員向けの利用時間計測と課金
- 時間外利用の自動検知と追加課金

#### 3. 会議室管理
- **会議室予約システム**
  - 週間カレンダーグリッドビュー（空き状況を一目で確認可能）
  - 30分刻みでの開始時刻選択（0分・30分）
  - 営業時間終了（22:00）を超えない自動制限
  - 選択時刻に基づく利用可能な最大時間の動的制限
  - 既存予約・Googleカレンダーイベントとの重複チェック
  - 利用できない時間帯の自動非表示・グレーアウト
- **プラン別の料金体系**
  - Room8会員（一般）：1,100円/時間
  - シェアオフィスプラン：月4時間まで無料、超過分1,100円/時間
  - Room8会員以外：2,200円/時間
- **Googleカレンダー連携**
  - リアルタイム同期（Push Notifications）
  - データベースキャッシュによる高速化
  - 定期同期の自動実行
  - 予約とGoogleカレンダーの自動統合
- **キャンセルポリシー**
  - **会員様**：
    - 予約日の前日24時（日付が変わるまで）：キャンセル料無料（決済手数料も発生しません）
    - 当日キャンセル：返金なし
    - シェアオフィスプラン（無料枠あり）：
      - 前日24時までキャンセル：無料枠が戻ります
      - 当日キャンセル：無料枠を消費します
    - ひと月まとめて決済のため、前日までキャンセルは決済手数料もかかりません
  - **非会員様**：
    - 予約日の前日24時（日付が変わるまで）：キャンセル料無料（決済手数料3.6%+40円のみ差し引きます）
    - 当日キャンセル：返金なし（100%）
    - 予約時に決済を行います。前日までキャンセルの場合、決済手数料のみ差し引いて返金されます

#### 4. ゲスト利用管理
- ゲスト本人による支払い or 代表者による支払い（選択可能）
- プラン別のゲスト利用ルール
- 複数人での利用管理

#### 5. 決済・課金システム
- **クレジットカード決済**（メイン）
  - 定期会費の自動引き落とし（毎月1日）
  - ドロップイン利用料金
  - 会議室利用料金
- **銀行振込**（手動管理）
  - 振込確認後の手動処理
- 未決済時の警告表示（ログイン時）

#### 6. データ分析・可視化
- 管理者向けダッシュボード
- 各種レポート機能
- データエクスポート機能（CSV/Excel）
- AI分析連携（生成AIでの分析対応）

## 📊 料金体系

### ドロップイン料金
- 1時間：400円
- 最大料金：2,000円（税込み）

### 会議室料金
- Room8会員（一般）：1,100円/時間
- Room8会員（シェアオフィスプラン）：月4時間まで無料、超過分1,100円/時間
- Room8会員以外：2,200円/時間

### 定期会員プラン
- 約9プラン存在
- 各プランで利用可能時間が異なる
- 時間外利用は追加課金

## 📁 プロジェクト構成

```
Room8/
├── README.md                 # 本ファイル（プロジェクト概要・進捗状況）
├── requirements.md           # 要件定義書
├── system-specs.md           # システム仕様書
├── development-plan.md       # 開発計画書（開発手順・フェーズ）
├── pricing.md                # 料金プラン・プラン体系（統合）
├── infrastructure.md         # サーバー構成・コスト・成長戦略（統合）
├── auth.md                   # 認証・ログイン・チェックイン（統合）
├── line-integration.md       # LINE連携（統合）
├── database-design.md        # データベース設計書
├── _guides/                  # 一時的なガイドファイル（Git管理外）
└── supabase/
    └── migrations/           # データベースマイグレーションファイル
```

### 📝 ドキュメント管理ルール

#### Git管理下（ルート）
**永続的なドキュメント**をGit管理下に配置します：
- 仕様書（requirements.md, system-specs.md, etc.）
- 設計書（database-design.md, etc.）
- 計画書（development-plan.md, etc.）
- プロジェクト概要（README.md）

#### Git管理外（`_guides/`）
**一時的なガイドファイル**は`_guides/`ディレクトリに保存し、Git管理外にします：
- 設定手順ガイド（環境構築手順など）
- トラブルシューティングガイド
- 一時的なメモや作業ログ

**理由**：
- 一度設定が完了すれば不要になるファイルはGit履歴に残さない
- リポジトリをクリーンに保つ
- 必要な場合は`_guides/`ディレクトリをローカルで参照可能

**注意**：
- `_guides/`ディレクトリは`.gitignore`で除外されているため、Gitにコミットされません
- ローカルでのみ保存され、必要に応じて削除可能です

## 🚀 開発環境のセットアップ

### 開発方針

- **エディタ**: Cursor（Mac mini / MacBook）
- **コード編集**: Cursorで行う
- **ローカル実行**: 行わない（Vercelでテスト）
- **環境変数**: Vercelで設定済み（ローカルでは不要）
- **開発者**: 1名のみ

### 別の環境（Mac）でプロジェクトを取得する場合

#### 1. リポジトリをクローン

```bash
git clone https://github.com/room8inc/room8-system.git
cd room8-system
```

#### 2. 依存関係のインストール

Cursorでの型チェックやLintのために依存関係をインストールします：

```bash
npm install
```

**注意**：
- ローカルでの実行（`npm run dev`）は**行いません**
- コード編集 → GitHubにpush → Vercelで自動デプロイ、という流れです
- テスト・動作確認はVercelの本番環境で行います

#### 3. 環境変数について

- **ローカル環境では不要**（Vercelで設定済み）
- `.env.local`は作成する必要がありません
- 環境変数はVercelダッシュボードで管理します

**設定されている環境変数一覧**（Vercel Dashboardで確認）:
- `NEXT_PUBLIC_SUPABASE_URL` - SupabaseプロジェクトURL
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Supabase公開キー（クライアントサイド用）
- `SUPABASE_SERVICE_ROLE_KEY` - Supabaseサービスロールキー（サーバーサイド用、管理者操作に必要）
- `STRIPE_SECRET_KEY_TEST` - Stripe秘密キー（テスト環境）
- `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` - Stripe公開キー（クライアントサイド用）
- `GOOGLE_OAUTH_CLIENT_ID` - Google OAuth 2.0クライアントID（Googleカレンダー連携用）
- `GOOGLE_OAUTH_CLIENT_SECRET` - Google OAuth 2.0クライアントシークレット
- `GOOGLE_OAUTH_REDIRECT_URI` - OAuth認証のリダイレクトURI（推奨）
- `NEXT_PUBLIC_SITE_URL` - 本番環境のURL（オプション）
- `CRON_SECRET` - Vercel Cronジョブの認証用シークレット（オプション）

詳細は `ENV_VARIABLES.md` を参照してください。

#### 4. コード編集後の流れ

```bash
git add .
git commit -m "変更内容"
git push origin main
```

→ Vercelが自動的にデプロイを開始します ✅

#### 5. デプロイの確認

- Vercelダッシュボードでデプロイ状況を確認
- デプロイ完了後、本番URLで動作確認

## 🔄 プロジェクトステータス

### 現在のフェーズ
**Phase 1: MVP開発中** - 会議室予約機能実装完了、管理画面拡張中

#### Phase 0: 準備フェーズ ✅ **完了**
- ✅ 要件定義
- ✅ プラン体系・料金構造の設計
- ✅ システム仕様の確定
- ✅ 技術スタック選定（Next.js + Supabase + Vercel）
- ✅ 開発環境構築（GitHub、Vercel、Supabase）
- ✅ 環境変数設定

#### Phase 1: MVP開発フェーズ ⏳ **進行中**
- ✅ **Phase 1-1: データベース設計** ✅ **完了**
  - ✅ ER図作成
  - ✅ テーブル設計（5テーブル）
  - ✅ マイグレーション作成・実行
  - ✅ 初期データ投入（9プラン）
  - ✅ RLS有効化
- ✅ **Phase 1-2: 認証・会員登録機能** ✅ **完了**
  - ✅ Supabaseクライアント設定
  - ✅ ログインページ実装
  - ✅ 会員登録ページ実装
  - ✅ ダッシュボードページ実装
  - ✅ セッション管理実装
  - ✅ ログアウト機能実装
  - ✅ 動作確認完了
- ✅ **Phase 1-3: チェックイン/チェックアウト機能** ✅ **完了**
  - ✅ QRコード読み取り機能実装（html5-qrcode）
  - ✅ チェックイン/チェックアウトAPI実装
  - ✅ ダッシュボードにチェックイン状態表示
  - ✅ checkinsテーブルのRLSポリシー追加
  - ✅ エラーハンドリング強化
  - ✅ 動作確認完了（チェックイン・チェックアウト成功）
- ✅ **Phase 1-4: 会議室予約機能** ✅ **完了**
  - ✅ 週間カレンダーグリッドビュー実装
  - ✅ 予約フォーム実装（30分刻み選択、営業時間制限）
  - ✅ Googleカレンダー連携（リアルタイム同期）
  - ✅ 空き状況チェック機能
  - ✅ 利用時間の動的制限機能
  - ✅ 予約一覧表示機能
- ⏳ **Phase 1-5: 基本的な管理画面** ⏳ **進行中**
  - ✅ Googleカレンダー管理画面（OAuth認証、設定）
  - ✅ 会員管理機能
  - ⏳ 管理者ダッシュボード（基本統計）
  - ⏳ チェックイン/チェックアウトログ閲覧

## 📝 ドキュメント

### 主要ドキュメント
- **[要件定義書](./requirements.md)**
  - 全体の要件定義
  - 主要機能の詳細
  - 会員管理、チェックイン/チェックアウト、会議室管理、ゲスト利用、決済・課金

- **[料金プラン・プラン体系](./pricing.md)**
  - 定期会員プラン詳細（9プラン）
  - 料金体系（ドロップイン、会議室、時間外利用）
  - 決済・課金タイミング
  - 割引システム、オプション

- **[システム仕様書](./system-specs.md)**
  - 会議室・設備管理（会議室1室、ロッカー手動管理）
  - チェックイン/チェックアウト（QRコード方式）
  - 会員登録時の情報（個人・法人・ドロップイン）
  - 時間外利用の詳細仕様（10分猶予、15分超過から課金）
  - システム要件（低コスト、MCPサーバー活用）

- **[開発計画書](./development-plan.md)**
  - 開発フェーズ（Phase 0〜6）
  - 技術スタック選定
  - 開発効率化のポイント
  - 優先順位付け
  - スケジュール

- **[インフラ構成](./infrastructure.md)**
  - サーバー構成案（Vercel + Supabase推奨）
  - コスト見積もり（1日30人想定、無料枠で運用可能）
  - 成長戦略（段階的な運用方針：無料プランで開始 → 成長時に有料プランへ）

- **[認証・ログイン・チェックイン](./auth.md)**
  - ログイン方法（メール+パスワード、セッション30日間保持）
  - チェックインフロー（事前ログイン + 会場ではQRのみ）
  - QRコード設計（会場QR、個人用QR、会議室QR）
  - セッション管理・個人識別の仕組み

- **[LINE連携](./line-integration.md)**
  - LINE連携の選択肢
  - LINE公式アカウントの料金詳細（無料プランでOK）
  - 個別メッセージの料金（月200通まで無料）
  - 決定事項（Phase 2で追加、オプション）

- **[セットアップガイド](./setup-guide.md)**
  - 必要なアカウント作成手順（Vercel、Supabase、Stripe）
  - 全て無料でアカウント作成可能
  - 環境変数の設定方法

## 🎯 主要ユーザー

### 一般会員
- 定期会員・ドロップイン会員
- チェックイン/チェックアウト
- 会議室予約
- 決済履歴確認
- プラン変更申請

### 管理者
- 全データの閲覧・管理
- 会員管理
- **Googleカレンダー管理**
  - OAuth認証によるGoogleカレンダー接続
  - カレンダー選択・設定
  - Webhook設定（リアルタイム同期）
  - 接続テスト機能
- 手動決済処理（銀行振込の確認など）
- データエクスポート
- AI分析の実行

## 🔐 認証・セキュリティ

### ログイン方法
- **メール+パスワードログイン + ログイン状態保持**（メイン）
  - ログイン時に「ログイン状態を保持」チェックボックス
  - セッションを30日間保持
  - 次回以降：アプリを開けば自動ログイン
  - **会場では会場のQRコードを一度読むだけ**（ログイン済み状態）
- **LINE連携**（Phase 2で追加、オプション）

### セキュリティ
- 権限管理（一般会員、管理者）
- 個人情報保護
- セッション管理（HttpOnly Cookie）
- サーバー側でユーザーIDを管理

詳細は以下を参照してください：
- **[認証・ログイン・チェックイン](./auth.md)** - ログイン方法、チェックインフロー、QRコード設計、セッション管理
- **[インフラ構成](./infrastructure.md)** - サーバー構成案、コスト見積もり、成長戦略
- **[LINE連携](./line-integration.md)** - LINE連携の選択肢、料金詳細、個別メッセージの料金

## 📧 通知機能

- 予約確認メール
- チェックイン/チェックアウト通知
- プラン変更通知
- 決済関連通知
  - 決済日のリマインダー
  - 決済失敗時の通知
  - 未決済時の警告

## 🔄 次ステップ

### 現在の進捗

**Phase 1: MVP開発中** - 会議室予約機能実装完了、管理画面拡張中

#### 完了したこと
- ✅ Phase 0: 準備フェーズ完了
- ✅ Phase 1-1: データベース設計完了
  - 5テーブル作成（users, plans, user_plans, checkins, lockers）
  - 9プランの初期データ投入
- ✅ Phase 1-2: 認証機能の基本実装完了
  - ログイン・会員登録・ダッシュボードページ
  - Supabase Auth統合
  - セッション管理
  - ログアウト機能
- ✅ Phase 1-3: チェックイン/チェックアウト機能完了
  - QRコード読み取り機能
  - チェックイン/チェックアウトAPI
  - ダッシュボードでの状態表示
- ✅ Phase 1-4: 会議室予約機能完了
  - 週間カレンダーグリッドビュー
  - 予約フォーム（30分刻み選択、営業時間制限、利用時間の動的制限）
  - Googleカレンダー連携（リアルタイム同期、Webhook処理）
  - 空き状況チェック機能
  - 予約一覧表示
- ✅ 解約フロー整備（2025-11）
  - 解約申請 UI を月単位選択に変更し、自動で月末に正規化
  - 解約取り消しボタン／API を実装し、Stripe 側のキャンセル予約も解除可能に
  - 月初バッチ (`/api/cron/monthly-billing`) で解約確定と解約金課金を実行
  - Vercel Cron で Supabase サービスロールを使用し、RLS を回避してバッチ運用

#### 次のステップ（優先順位順）

1. **Phase 1-5: 基本的な管理画面** ⏳ **進行中**
   - ✅ Googleカレンダー管理画面（OAuth認証、設定）
   - ✅ 会員管理機能
   - ⏳ 管理者ダッシュボード（基本統計）
   - ⏳ チェックイン/チェックアウトログ閲覧
2. **Phase 2: 決済機能**
   - Stripe統合
   - 定期会費の自動引き落とし
   - 会議室利用料金の決済処理

詳細は [開発計画書](./development-plan.md) を参照してください。

## 📌 重要な仕様詳細

### 時間外利用の仕様（確定済み）
- **猶予時間**: 10分まで無料
- **課金開始**: 15分超過から
- **料金**: 30分200円、1時間400円、最大2,000円（ドロップインと同じ）
- **課金タイミング**: Room8会員は会議室利用と合算して月末（翌月1日）にまとめて請求

### 会議室決済タイミング（確定済み）
- **ドロップイン会員**: 予約時に決済
- **Room8会員**: 時間外利用と合算して月末（翌月1日）にまとめて請求

### 決済失敗時の対応（確定済み）
- **Room8会員の決済失敗**：
  - ダッシュボードの目立つ位置に警告を表示
  - 利用は可能だが、確認・決済を促す
  - 直ちに使えなくする必要はない

### ドロップイン決済方式（デビットカード対応・確定済み）
- **問題**: デビットカードの場合、チェックアウト時に決済できない可能性がある
- **解決策**: チェックイン時に最大料金（2,000円）を事前決済（オーソリ）
  - チェックアウト時に実際の利用時間に応じた料金を計算
  - 差額を返金（例：500円利用なら、1,500円を返金）
- **メリット**: 
  - デビットカードでも確実に決済できる
  - 利用上限を保証できる
- **技術的実装**: Stripeの「Authorization and Capture」または「Refund」機能を活用

### チェックイン/チェックアウト（確定済み）
- **方法**: QRコード読み取り方式
- **実装**: アプリでQRコードを読み取り
- **ログイン方針**: 事前ログイン + 会場ではQRのみ（セッション時間を長めに設定、パスワード保存機能も活用）

### 会議室・設備（確定済み）
- **会議室**: 1室のみ
- **ロッカー**: 管理画面から手動で調整可能

### システム要件（確定済み）
- **目標**: なるべく低コストで実現
- **開発コスト削減**: MCPサーバー等を活用

## 🎨 UI設計方針（利用者目線の導線設計）

### ダッシュボードの構成（優先順位順）

#### 1. ヘッダー
- **名前を大きく表示**（emailではなく氏名）
- ログアウトボタン

#### 2. 決済失敗警告（Room8会員向け・最優先表示）
- **Room8会員で決済が失敗している場合**：
  - ダッシュボードの目立つ位置（メインアクションエリアの上部）に警告を表示
  - 「⚠️ 決済に失敗しています。支払い方法を確認してください」のようなメッセージ
  - 利用は可能だが、確認・決済を促す
  - 「支払い方法を確認」ボタンで決済設定画面へ遷移

#### 3. メインアクションエリア（最優先）
- **チェックイン/チェックアウトボタン**を大きく、目立つ位置に配置
- チェックイン中の場合：
  - **経過時間**をリアルタイム表示
  - **ドロップイン会員**：現在の料金をリアルタイム表示（1時間400円、最大2,000円）
  - **定期会員**：
    - プランの利用可能時間/リミットを表示（例：17時まで）
    - 現在時刻と残り時間を表示
    - **時間外利用中**の場合：「⚠️ 時間外利用中」と追加料金を表示

#### 4. その他のアクション
- **会議室予約ボタン**

#### 5. その他の情報
- 今日の利用状況、利用履歴など

### フッターナビゲーション（常時表示）

全ページの下部に固定表示されるナビゲーション：

```
┌─────────────────────────────────────────┐
│ [ホーム] [スキャン] [会議室] [会員証]     │
│  🏠       📷      🏢      🎫          │
└─────────────────────────────────────────┘
```

#### 各ボタン
1. **ホーム** 🏠 → `/dashboard`
2. **スキャン** 📷 → チェックイン/チェックアウトモーダルを開く（現在の状態に応じて自動判定）
3. **会議室** 🏢 → `/meeting-rooms`（Phase 3で実装）
4. **会員証** 🎫 → `/member-card`

### 会員証画面の構成

#### 上部：会員証カード
- 氏名
- プラン名（定期会員の場合）
- 会員種別（定期/ドロップイン）
- 会員番号（任意）

#### 下部：メニューリスト
- **会員情報** → `/profile`（プロフィール編集）
- **パスワード変更** → （Phase 2で実装）
- **決済履歴・領収書** → （Phase 2で実装）
- **定額契約** → プラン情報、契約期間、変更履歴（Phase 4で実装）
- **支払方法** → クレジットカード変更（Phase 2で実装）
- **ログアウト**

詳細は [システム仕様書](./system-specs.md) の「UI設計・導線」セクションを参照してください。

## 📄 ライセンス

[ライセンス情報は後で追加予定]

## 👥 開発チーム

[開発チーム情報は後で追加予定]

---

**最終更新日**: 2025年1月27日

