# Room8 インフラ構成・コスト・成長戦略

## 🎯 目標

**低コストで実現するサーバー構成**
- 開発コスト削減（MCPサーバー等を活用）
- 運用コスト削減（無料枠・低コストサービスの活用）
- スケーラビリティを考慮（将来的な拡張）

---

## 📋 サーバー構成案（推奨）

### 推奨：サーバーレス構成（Vercel + Supabase）

**構成：**
- **フロントエンド**: Vercel（Next.js）
- **バックエンド**: Next.js API Routes（Vercel）
- **データベース**: Supabase（PostgreSQL）
- **認証**: NextAuth.js（Vercel）
- **決済**: Stripe（外部API）
- **ファイルストレージ**: Supabase Storage（身分証明書など）
- **セッション管理**: Vercel Edge Config または Supabase

**構成詳細：**
```
┌─────────────────────────────┐
│   ユーザー（ブラウザ/スマホ）    │
└──────────────┬──────────────┘
               │ HTTPS
               ↓
┌─────────────────────────────┐
│   Vercel（Next.js）          │
│   - フロントエンド             │
│   - API Routes（バックエンド） │
│   - Edge Functions           │
└──────────────┬──────────────┘
               │
       ┌───────┴────────┐
       │                 │
       ↓                 ↓
┌──────────────┐  ┌──────────────┐
│  Supabase    │  │    Stripe    │
│  - PostgreSQL│  │  - 決済処理  │
│  - Auth      │  │              │
│  - Storage   │  │              │
└──────────────┘  └──────────────┘
```

**メリット：**
- ✅ **コストが非常に低い**（無料枠が充実）
- ✅ 実装が簡単（フルスタックで開発効率化）
- ✅ 自動スケーリング（サーバー管理不要）
- ✅ グローバルCDN（高速アクセス）
- ✅ サーバー管理不要

**デメリット：**
- ❌ コールドスタート（初回アクセスがやや遅い）
- ❌ 実行時間制限（Function実行時間に制限あり）

---

## 💰 コスト見積もり

### 想定利用者数
- **1日のチェックイン数**: 20〜30人
- **最大想定**: 1日30人

### 月間の利用想定
- **チェックイン/チェックアウト**: 1日30人 × 2回 = 60回/日
- **月間**: 60回 × 30日 = **1,800回/月**
- **ログイン**: 1日30回（初回ログイン想定） = **900回/月**
- **会議室予約**: 1日10回想定 = **300回/月**
- **その他API呼び出し**: 約500回/月
- **合計API呼び出し**: 約**3,500回/月**

---

## 📊 無料枠での使用量見積もり

### Vercel 無料枠

**制限：**
- 月100GB転送
- 1000回ビルド
- 無制限のAPIリクエスト（Function実行時間制限あり）

**想定使用量：**
- **転送量**: 1日30人 × 100KB（ページ読み込み） × 10回（平均アクセス） = 約30MB/日
- **月間転送**: 30MB × 30日 = **約900MB/月** ✅ 100GB以内（十分余裕）
- **ビルド**: 開発時に数回/日 = 月90回程度 ✅ 1000回以内（十分余裕）
- **APIリクエスト**: 月3,500回程度 ✅ 無制限（問題なし）

**使用率：**
- **転送量**: 900MB / 100GB = **0.9%使用** ✅ **余裕あり**
- **ビルド**: 90回 / 1000回 = **9%使用** ✅ **余裕あり**

**結論**: ✅ **Vercel無料枠で十分収まる**

---

### Supabase 無料枠

**制限：**
- 500MB データベース容量
- 1GB ファイルストレージ
- 2GB 転送（データベース + ストレージ）
- 50,000行（テーブル行数制限）

**想定使用量：**

#### データベース容量
- **会員データ**: 100人 × 10KB = 1MB
- **チェックインログ**: 月1,800回 × 1KB = 1.8MB
- **予約データ**: 月300件 × 2KB = 600KB
- **セッションデータ**: 100人 × 1KB = 100KB
- **その他テーブル**: 約10MB
- **合計**: 約**14MB** ✅ 500MB以内（十分余裕）

#### ファイルストレージ（身分証明書等）
- **身分証明書**: 100人 × 2MB = 200MB
- **登記簿謄本**: 10法人 × 5MB = 50MB
- **合計**: 約**250MB** ✅ 1GB以内（十分余裕）

#### 転送量
- **データベースクエリ**: 月3,500回 × 10KB = 約35MB
- **ファイルダウンロード**: 月50回 × 2MB = 100MB
- **合計**: 約**135MB/月** ✅ 2GB以内（十分余裕）

#### テーブル行数
- **会員**: 100行
- **チェックインログ**: 月1,800行（1年間で約21,600行）
- **予約データ**: 月300行（1年間で約3,600行）
- **セッション**: 100行
- **その他**: 約500行
- **合計**: 約**26,000行** ✅ 50,000行以内（十分余裕）

**使用率：**
- **データベース容量**: 14MB / 500MB = **2.8%使用** ✅ **余裕あり**
- **ファイルストレージ**: 250MB / 1GB = **25%使用** ✅ **余裕あり**
- **転送量**: 135MB / 2GB = **6.75%使用** ✅ **余裕あり**
- **テーブル行数**: 26,000行 / 50,000行 = **52%使用** ⚠️ **現状は問題なし**（1年後要確認）

**結論**: ✅ **Supabase無料枠で十分収まる**

---

## 💰 コスト試算

### Phase 1（MVP）のコスト

**無料枠での運用（1日20〜30人の想定）：**
- ✅ **Vercel**: 無料枠（月額0円）
- ✅ **Supabase**: 無料枠（月額0円）
- ✅ **Stripe**: 決済手数料のみ
- **合計**: **月額0円**（無料枠内で十分運用可能）

**有料での運用（中規模・1日50人以上になった場合）：**
- ⚠️ **Vercel**: 無料枠 or 月$20（Proプラン = 約3,000円）
- ⚠️ **Supabase**: 月$25（Proプラン = 約3,750円）- テーブル行数制限解除
- ✅ **Stripe**: 決済手数料のみ
- **合計**: 月額約$25〜$45（約3,750円〜6,750円）

---

## 📈 成長戦略（段階的な運用方針）

### Phase 1: 開始時（無料プランで運用）

**規模：**
- 1日のチェックイン数: 20〜30人
- 月間の利用者数: 約100〜150人程度

**コスト：**
- ✅ **Vercel**: 無料枠（月額0円）
- ✅ **Supabase**: 無料枠（月額0円）
- ✅ **Stripe**: 決済手数料のみ
- ✅ **LINE公式アカウント**: 無料プラン（月額0円）
- **合計: 月額0円**

**メリット：**
- ✅ コストがかからない（月額0円）
- ✅ 小規模運用には十分
- ✅ 無料枠で運用可能

---

### Phase 2: 成長時（有料プランにアップグレード）

**規模：**
- 1日のチェックイン数: 50人以上
- 月間の利用者数: 約500人以上

**コスト：**
- ⚠️ **Vercel**: 無料枠 or Proプラン（月額$20 = 約3,000円）
- ⚠️ **Supabase**: Proプラン（月額$25 = 約3,750円）
- ✅ **Stripe**: 決済手数料のみ
- ⚠️ **LINE公式アカウント**: ライトプラン（月額5,500円）
- **合計: 月額約12,250円〜**

**アップグレードのタイミング：**
- 会員数が増えて活発になったら
- 月200通を超える個別メッセージが必要になったら
- データベース容量が500MBを超えたら
- テーブル行数が50,000行を超えたら

**メリット：**
- ✅ 大規模運用に対応
- ✅ より多くの機能が利用可能
- ✅ 制限が緩和される

---

### Phase 3: 大規模運用時（エンタープライズプラン）

**規模：**
- 1日のチェックイン数: 100人以上
- 月間の利用者数: 約2,000人以上

**コスト：**
- ⚠️ **Vercel**: Enterpriseプラン（月額$100〜）
- ⚠️ **Supabase**: Enterpriseプラン（月額$100〜）
- ✅ **Stripe**: 決済手数料のみ
- ⚠️ **LINE公式アカウント**: スタンダードプラン（月額16,500円）
- **合計: 月額約50,000円〜**

---

## ⚠️ 注意点

### 1. テーブル行数の制限
- **現状**: 約26,000行（52%使用）
- **1年後**: 約52,000行（制限を超える可能性）
- **対策**: 
  - 古いログを定期的にアーカイブ
  - またはSupabase Proにアップグレード（月$25）

### 2. 成長時の対応
- **利用者が増えた場合（1日50人以上）**: 
  - データベース容量や転送量が増える
  - 無料枠を超える可能性がある
  - Supabase Proへのアップグレードを検討

### 3. ファイルストレージ
- **身分証明書などの画像**: 250MB使用
- **1GB以内なので問題なし**
- **今後追加されるファイル（会議室利用時の写真など）も考慮**

---

## 🔧 各サービスの役割

### Vercel
- **役割**: フロントエンド + バックエンド（API Routes）
- **機能**: 
  - Next.jsアプリのホスティング
  - APIエンドポイント
  - グローバルCDN
  - 自動デプロイ（Git連携）
- **コスト**: 無料枠 or 月$20〜

### Supabase
- **役割**: データベース + 認証 + ストレージ
- **機能**:
  - PostgreSQLデータベース
  - 認証（メール+パスワード、OAuth等）
  - ファイルストレージ（身分証明書等）
  - リアルタイム機能（将来的に活用可能）
- **コスト**: 無料枠 or 月$25〜

### Stripe
- **役割**: 決済処理
- **機能**:
  - クレジットカード決済
  - 定期課金（サブスクリプション）
  - 自動引き落とし
- **コスト**: 決済手数料のみ（3.6% + 固定費）

### LINE（Phase 2）
- **役割**: ログイン認証 + 通知
- **機能**:
  - LINEログイン（OAuth）
  - LINE Messaging API（通知）
- **コスト**: 無料（LINE公式アカウントのみ月額0円〜）

---

## 🛠️ 開発環境

### ローカル開発環境

```
開発マシン
├─ Next.js（開発サーバー）
├─ Supabase（ローカル or 開発用インスタンス）
├─ Stripe（テストモード）
└─ LINE（開発用アカウント）
```

### 本番環境

```
本番環境
├─ Vercel（本番デプロイ）
├─ Supabase（本番インスタンス）
├─ Stripe（本番モード）
└─ LINE（本番アカウント）
```

---

## 📈 スケーリング計画

### 小規模（〜100ユーザー）
- **構成**: 無料枠（Vercel + Supabase）
- **コスト**: 月額0円
- **機能**: 基本機能のみ

### 中規模（〜1,000ユーザー）
- **構成**: Vercel Pro + Supabase Pro
- **コスト**: 月額約$45（約6,750円）
- **機能**: 全機能

### 大規模（1,000ユーザー〜）
- **構成**: Vercel Enterprise + Supabase Enterprise
- **コスト**: 月額$100〜
- **機能**: 全機能 + 高度な機能

---

## 🔐 セキュリティ考慮事項

### 必要な対策
1. **HTTPS**: Vercelが自動で対応（SSL証明書）
2. **データベース**: Supabaseが自動でバックアップ
3. **認証**: NextAuth.js + Supabase Authでセキュア
4. **セッション管理**: HttpOnly Cookieで安全
5. **環境変数**: Vercelの環境変数で管理

---

## ✅ 決定事項

### 推奨：サーバーレス構成（Vercel + Supabase）

**構成：**
- フロントエンド + バックエンド: Vercel（Next.js）
- データベース + 認証 + ストレージ: Supabase
- 決済: Stripe

**メリット：**
- ✅ コストが最も低い（無料枠で開始可能）
- ✅ 実装が簡単（フルスタックで開発効率化）
- ✅ 運用が簡単（サーバー管理不要）
- ✅ 自動スケーリング

**コスト：**
- **Phase 1（1日20〜30人想定）**: ✅ **無料枠で運用可能（月額0円）**
- **Phase 1（1日50人以上）**: 月額約$25〜$45（Supabase Proが必要な場合）
- **Phase 2**: 上記 + LINE公式アカウント（無料プランで月額0円）

**成長戦略：**
- ✅ **まずは無料プランで十分**
- ✅ **そのうち会員数が増えて活発になってきたら有料プランにアップグレード**

---

## 🎯 次のステップ

### すぐに始めること
1. **Vercelアカウント作成**（無料）
   - https://vercel.com
   - GitHubアカウントでサインアップ（推奨）
2. **Supabaseアカウント作成**（無料）
   - https://supabase.com
   - プロジェクトを作成（リージョン: Tokyo推奨）
3. **Stripeアカウント作成**（無料）
   - https://stripe.com/jp
   - テストモードで開発可能
4. **開発環境構築**
   - Node.jsのインストール
   - Next.jsプロジェクトの初期化

**詳細**: [セットアップガイド](./setup-guide.md) を参照してください。

### 実装順序
1. Next.jsプロジェクト初期化
2. Supabase接続設定
3. 認証機能実装
4. データベース設計・実装
5. チェックイン/チェックアウト機能実装

